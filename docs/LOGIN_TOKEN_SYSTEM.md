# Login Token System Documentation

## Overview

The Tiny Little backend implements a dual login token system to manage game access control:
- **V1 (Legacy)**: Stores login tokens in `/Users/{userId}/GameStats/{gameId}/loginToken`
- **V2 (New)**: Stores login tokens in `/Users/{userId}/loginToken`

Both systems work in parallel to ensure backward compatibility.

---

## Table of Contents

1. [Token Types](#token-types)
2. [Token Storage Locations](#token-storage-locations)
3. [API Endpoints](#api-endpoints)
4. [Testing Guide](#testing-guide)
5. [Token Flow Diagrams](#token-flow-diagrams)
6. [Implementation Details](#implementation-details)

---

## Token Types

### 1. JWT Token (Authentication)
- **Purpose**: API authentication and authorization
- **Storage**: Client-side (localStorage/cookies)
- **Lifespan**: 30 days (configurable via `jwt.expiresIn`)
- **Generated by**: `/api/auth/credentials/login`
- **Used for**: Accessing protected endpoints

### 2. Game Login Token
- **Purpose**: Game-specific login verification
- **Storage**: Database (Firestore)
- **Lifespan**: 5 minutes initial, extendable on use
- **Generated by**: `/api/game-stats/{gameId}` endpoints
- **Used for**: In-game login validation

---

## Token Storage Locations

### V1 (Legacy System)
```
/Users/{userId}/GameStats/{gameId}/loginToken
```

**Structure:**
```javascript
{
  token: string,           // Random 8-character token
  issueAt: Timestamp,      // When token was created
  expireAt: Timestamp,     // When token expires
  status: number           // 9 = Ready, 10 = InUse, 0 = Revoked
}
```

### V2 (New System)
```
/Users/{userId}/loginToken
```

**Structure:** (Same as V1)
```javascript
{
  token: string,
  issueAt: Timestamp,
  expireAt: Timestamp,
  status: number
}
```

### Token Status Enum
```typescript
enum LoginTokenStatus {
  Revoked = 0,
  Ready = 9,
  InUse = 10
}
```

---

## API Endpoints

### Authentication Endpoints

#### 1. Login (Get JWT Token)
```http
POST /api/auth/credentials/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "577c44ac-28f4-5fd5-b38c-c061ffed0d70",
    "authUserId": "577c44ac-28f4-5fd5-b38c-c061ffed0d70",
    "email": "user@example.com",
    "displayName": "Username",
    "isGuestAccount": false,
    ...
  }
}
```

---

### Game Token Generation Endpoints

#### 2. Create Game Token (Authenticated Users)
```http
POST /api/game-stats/{gameId}
Authorization: Bearer <jwt-token>
```

**Response:**
```json
{
  "token": "abc12345",
  "userId": "577c44ac-28f4-5fd5-b38c-c061ffed0d70",
  "username": "Username"
}
```

**Token Storage:**
- ✅ Writes to `/Users/{userId}/loginToken`
- ✅ Writes to `/Users/{userId}/GameStats/{gameId}/loginToken`

---

#### 3. Create Game Token (Guest Users)
```http
POST /api/game-stats/{gameId}/unprotected
```

**Response:**
```json
{
  "token": "xyz98765",
  "userId": "generated-guest-uuid",
  "username": "Guest123456"
}
```

**Token Storage:**
- ✅ Writes to `/Users/{userId}/loginToken`
- ✅ Writes to `/Users/{userId}/GameStats/{gameId}/loginToken`

---

#### 4. Update Guest Token
```http
PUT /api/game-stats/{gameId}/unprotected
Content-Type: application/json

{
  "userId": "existing-guest-uuid",
  "username": "Guest123456"
}
```

**Use Case:** Refresh token for existing guest user

---

### Game Login Endpoints

#### 5. In-Game Login V1 (Legacy)
```http
POST /api/users/{userId}/games/{gameId}/ingame-login
Content-Type: application/json

{
  "token": "abc12345"
}
```

**Token Verification:**
- ❌ Reads from `/Users/{userId}/GameStats/{gameId}/loginToken`
- ✅ Creates new game stat if doesn't exist
- ✅ Updates token expiration on success

---

#### 6. In-Game Login V2 (New)
```http
POST /api/users/{userId}/games/{gameId}/ingame-login-v2
Content-Type: application/json

{
  "token": "abc12345"
}
```

**Token Verification:**
- ✅ Reads from `/Users/{userId}/loginToken` ← **Main difference!**
- ✅ Creates new game stat if doesn't exist
- ✅ Updates token in BOTH locations for backward compatibility

---

#### 7. Verify Login Token
```http
POST /api/users/{userId}/games/{gameId}/verify-login-token
Content-Type: application/json

{
  "token": "abc12345"
}
```

**Purpose:** Verify token validity without full login
**Token Location:** `/Users/{userId}/GameStats/{gameId}/loginToken` (V1 only)

---

## Testing Guide

### Test Scenario 1: Guest User Flow

**Step 1: Create Guest Account & Token**
```bash
curl -X POST http://localhost:3000/api/game-stats/tiny-little-fly/unprotected
```

**Response:**
```json
{
  "token": "abc12345",
  "userId": "guest-uuid-here",
  "username": "Guest123456"
}
```

**Step 2: Test V2 Login**
```bash
curl -X POST http://localhost:3000/api/users/guest-uuid-here/games/tiny-little-fly/ingame-login-v2 \
  -H "Content-Type: application/json" \
  -d '{"token": "abc12345"}'
```

**Expected Response:**
```json
{
  "isSuccess": true,
  "message": "",
  "data": { ... }
}
```

---

### Test Scenario 2: Authenticated User Flow

**Step 1: Login and Get JWT**
```bash
curl -X POST http://localhost:3000/api/auth/credentials/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'
```

**Save the JWT token and user ID from response**

**Step 2: Generate Game Login Token**
```bash
curl -X POST http://localhost:3000/api/game-stats/tiny-little-fly \
  -H "Authorization: Bearer <jwt-token>"
```

**Response:**
```json
{
  "token": "xyz98765",
  "userId": "577c44ac-28f4-5fd5-b38c-c061ffed0d70",
  "username": "Username"
}
```

**Step 3: Test V2 Login**
```bash
curl -X POST http://localhost:3000/api/users/577c44ac-28f4-5fd5-b38c-c061ffed0d70/games/tiny-little-fly/ingame-login-v2 \
  -H "Content-Type: application/json" \
  -d '{"token": "xyz98765"}'
```

---

### Test Scenario 3: Token Expiration

**Step 1: Create Token**
```bash
curl -X POST http://localhost:3000/api/game-stats/tiny-little-fly/unprotected
```

**Step 2: Wait 5+ minutes**

**Step 3: Try Login (Should Fail)**
```bash
curl -X POST http://localhost:3000/api/users/{userId}/games/tiny-little-fly/ingame-login-v2 \
  -H "Content-Type: application/json" \
  -d '{"token": "expired-token"}'
```

**Expected Response:**
```json
{
  "isSuccess": false,
  "message": "Login is already expired. Please launch the game via website again"
}
```

---

### Postman Collection Setup

**Environment Variables:**
```javascript
// After login, add to Tests tab:
var jsonData = pm.response.json();
pm.environment.set("jwt_token", jsonData.token);
pm.environment.set("user_id", jsonData.user.id || jsonData.user.authUserId);

// After game token generation:
var jsonData = pm.response.json();
pm.environment.set("game_token", jsonData.token);
```

**Request Chain:**
1. Login → Saves `{{jwt_token}}` and `{{user_id}}`
2. Generate Game Token → Saves `{{game_token}}`
3. V2 Login → Uses all variables

---

## Token Flow Diagrams

### V1 Flow (Legacy)
```
┌─────────────────────────────────────────────────────────────┐
│                     V1 Login Flow                           │
└─────────────────────────────────────────────────────────────┘

User/Game Client
      │
      ├─1─► POST /game-stats/{gameId}  (Create Token)
      │     └─► Writes to: /Users/{userId}/GameStats/{gameId}/loginToken
      │
      ├─2─► POST /users/{userId}/games/{gameId}/ingame-login
      │     └─► Reads from: /Users/{userId}/GameStats/{gameId}/loginToken
      │     └─► Validates token
      │     └─► Updates token expiration
      │
      └─3─► Game Access Granted ✅
```

### V2 Flow (New)
```
┌─────────────────────────────────────────────────────────────┐
│                     V2 Login Flow                           │
└─────────────────────────────────────────────────────────────┘

User/Game Client
      │
      ├─1─► POST /game-stats/{gameId}  (Create Token)
      │     ├─► Writes to: /Users/{userId}/loginToken ✅
      │     └─► Writes to: /Users/{userId}/GameStats/{gameId}/loginToken (Backward compat)
      │
      ├─2─► POST /users/{userId}/games/{gameId}/ingame-login-v2
      │     ├─► Reads from: /Users/{userId}/loginToken ✅
      │     └─► Validates token
      │     ├─► Updates: /Users/{userId}/loginToken
      │     └─► Updates: /Users/{userId}/GameStats/{gameId}/loginToken (Backward compat)
      │
      └─3─► Game Access Granted ✅
```

---

## Implementation Details

### Token Generation (game-stats.repository.ts)

```typescript
async createLoginToken(
  userId: string,
  gameId: string,
  token: string,
): Promise<void> {
  try {
    const now = admin.firestore.Timestamp.now();
    const plus5M = now.toMillis() + ms('5m');

    const loginToken = {
      token,
      issueAt: now,
      expireAt: Timestamp.fromMillis(plus5M),
      status: 9, // Ready
    };

    // Write to GameStats (V1)
    await admin
      .firestore()
      .collection('Users')
      .doc(userId)
      .collection('GameStats')
      .doc(gameId)
      .set({ loginToken }, { merge: true });

    // Write to Users (V2)
    await admin
      .firestore()
      .collection('Users')
      .doc(userId)
      .set({ loginToken }, { merge: true });
  } catch (error) {
    console.log(error);
  }
}
```

**Location:** `src/modules/game-stats/game-stats.repository.ts:83-117`

---

### V2 Token Validation (user.service.ts)

```typescript
async ingameLoginV2(
  req: RequestContext,
  userId: string,
  gameId: string,
  body: UserIngameLoginDto,
) {
  const user = await this.userRepository.getOne(userId);

  // ... user validation ...

  if (Boolean(this.configService.get<boolean>('loginToken.checkEnabled'))) {
    // ✅ Read from /Users/{userId}/loginToken
    const userLoginToken = user.loginToken;

    // Validate token
    if (userLoginToken?.token !== body.token &&
        userLoginToken?.status == LoginTokenStatus.InUse) {
      return new ServiceResult(false, 'Invalid token');
    }

    // Check expiration
    if (!userLoginToken?.expireAt ||
        (userLoginToken.expireAt < Timestamp.now() &&
         userLoginToken.status == LoginTokenStatus.Ready)) {
      return new ServiceResult(
        false,
        'Login is already expired. Please launch the game via website again'
      );
    }

    // Check if revoked
    if (userLoginToken.status == LoginTokenStatus.Revoked) {
      return new ServiceResult(
        false,
        'Your login has been revoked. Please launch the game again'
      );
    }

    // Update token in BOTH locations
    const loginTokenToUpdate = { /* ... */ };

    // Update in /Users/{userId} (V2)
    await this.userRepository.update(userId, loginTokenToUpdate);

    // Update in /Users/{userId}/GameStats/{gameId} (V1 - backward compat)
    await this.userGameStatRepository.update(
      userId,
      gameId,
      loginTokenToUpdate
    );
  }

  // ... rest of login logic ...
}
```

**Location:** `src/modules/user/services/user.service.ts:583-782`

---

### User Model Update

```typescript
import { LoginToken } from '../entities/login-token.entity';

@Collection('Users')
export class User extends BaseUpdatableModel {
  // ... other properties ...

  @ApiProperty({ nullable: true, type: LoginToken })
  loginToken?: LoginToken;  // ✅ Added for V2 support

  // ... other properties ...
}
```

**Location:** `src/modules/user/models/user.model.ts:102`

---

## Configuration

### Environment Variables

```bash
# Login Token Configuration
LOGIN_TOKEN_CHECK_ENABLED=true        # Enable/disable token checking
LOGIN_TOKEN_EXPIRE_NEXT=300000        # Token extension time (ms) = 5 minutes

# JWT Configuration
JWT_SECRET=your-secret-key-here
JWT_EXPIRES_IN=30d                    # JWT expiration time
```

### Config File (config/configuration.ts)

```typescript
export default () => ({
  loginToken: {
    checkEnabled: process.env.LOGIN_TOKEN_CHECK_ENABLED === 'true',
    expireNext: parseInt(process.env.LOGIN_TOKEN_EXPIRE_NEXT) || 300000,
  },
  jwt: {
    secret: process.env.JWT_SECRET,
    expiresIn: process.env.JWT_EXPIRES_IN || '30d',
  },
});
```

---

## Migration Guide (V1 → V2)

### For Frontend/Game Clients

**No changes required!** Both V1 and V2 endpoints work in parallel.

**Recommended:** Migrate to V2 endpoints for better scalability:
- Old: `POST /users/{userId}/games/{gameId}/ingame-login`
- New: `POST /users/{userId}/games/{gameId}/ingame-login-v2`

### For Backend Services

1. **Token is now stored in two locations:**
   - `/Users/{userId}/loginToken` (V2 - primary)
   - `/Users/{userId}/GameStats/{gameId}/loginToken` (V1 - backward compat)

2. **Token validation reads from:**
   - V1: GameStats location
   - V2: Users location

3. **Both endpoints update both locations** to maintain consistency

---

## Troubleshooting

### Common Issues

#### 1. "Invalid token" Error
**Cause:** Token mismatch or wrong userId
**Solution:** Ensure you're using the same userId that was used to generate the token

#### 2. "Login is already expired" Error
**Cause:** Token expired (>5 minutes old and not in use)
**Solution:** Generate a new token via `/api/game-stats/{gameId}`

#### 3. "User not found" Error
**Cause:** Invalid userId in the URL
**Solution:** Verify userId matches the one from token generation

#### 4. Game settings null error
**Cause:** Missing game configuration in database
**Solution:** Ensure game settings exist in Firestore:
- `/Games/{gameId}/GameSettings/new-player`
- `/Games/{gameId}/GameSettings/exp-table`

#### 5. "Property 'loginToken' does not exist on type 'User'"
**Cause:** User model not updated
**Solution:** Ensure `loginToken` property is added to User model with correct import

---

## Security Considerations

### Token Security
1. **Short Lifespan:** Tokens expire after 5 minutes
2. **One-time Use:** Status changes from Ready (9) to InUse (10) after first use
3. **Revocation Support:** Tokens can be revoked (status = 0)
4. **Server-side Validation:** All token checks happen on the server

### Best Practices
1. ✅ Always use HTTPS in production
2. ✅ Enable `LOGIN_TOKEN_CHECK_ENABLED=true` in production
3. ✅ Rotate JWT secrets regularly
4. ✅ Monitor token usage patterns for anomalies
5. ✅ Implement rate limiting on token endpoints

### Token Lifecycle
```
┌─────────────────────────────────────────────────────────┐
│ Token States                                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Created (Status: 9 Ready)                              │
│       │                                                 │
│       ├──► First Use (Status: 10 InUse)                 │
│       │         │                                       │
│       │         ├──► Extended on Each Use               │
│       │         │                                       │
│       │         └──► Expires after 5min of inactivity   │
│       │                                                 │
│       └──► Can be Revoked (Status: 0)                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## API Reference Summary

| Endpoint | Method | Auth | Purpose | Token Location |
|----------|--------|------|---------|----------------|
| `/auth/credentials/login` | POST | None | Get JWT | N/A |
| `/game-stats/{gameId}` | POST | JWT | Create game token (auth users) | Both V1 & V2 |
| `/game-stats/{gameId}/unprotected` | POST | None | Create game token (guests) | Both V1 & V2 |
| `/users/{userId}/games/{gameId}/ingame-login` | POST | None | V1 Login | V1 only |
| `/users/{userId}/games/{gameId}/ingame-login-v2` | POST | None | V2 Login | V2 (reads), Both (writes) |
| `/users/{userId}/games/{gameId}/verify-login-token` | POST | None | Verify token | V1 only |

---

## Changelog

### Version 2.0 (Current)
- ✅ Added V2 login endpoint (`ingame-login-v2`)
- ✅ Token stored in `/Users/{userId}/loginToken`
- ✅ Backward compatibility with V1 maintained
- ✅ Updated User model with `loginToken` property
- ✅ Dual-write to both V1 and V2 locations

### Version 1.0 (Legacy)
- Token stored in `/Users/{userId}/GameStats/{gameId}/loginToken`
- Single location storage
- Game-specific tokens only

---

## Support

For issues or questions:
- GitHub Issues: https://github.com/tinylittlegame/tiny-little-backend/issues
- Documentation: This file
- Code References:
  - `src/modules/user/services/user.service.ts` (Login logic)
  - `src/modules/game-stats/game-stats.repository.ts` (Token generation)
  - `src/modules/user/models/user.model.ts` (User model)
  - `src/modules/user/controllers/user.controller.ts` (API endpoints)

---

**Last Updated:** 2025-10-09
**Author:** Claude Code
**Version:** 2.0
